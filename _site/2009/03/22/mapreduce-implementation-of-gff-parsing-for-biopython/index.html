<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>MapReduce implementation of GFF parsing for Biopython &#8211; Blue Collar Bioinformatics</title>

<meta name="keywords" content="how-to">

  

<!-- Twitter Cards -->
<meta name="twitter:title" content="MapReduce implementation of GFF parsing for Biopython">

<meta name="twitter:site" content="@chapmanb">
<meta name="twitter:creator" content="@chapmanb">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="MapReduce implementation of GFF parsing for Biopython">

<meta property="og:url" content="http://localhost:4000/2009/03/22/mapreduce-implementation-of-gff-parsing-for-biopython/">
<meta property="og:site_name" content="Blue Collar Bioinformatics">





<link rel="canonical" href="http://localhost:4000/2009/03/22/mapreduce-implementation-of-gff-parsing-for-biopython/">
<link href="http://feeds2.feedburner.com/bcbio" type="application/atom+xml" rel="alternate" title="Blue Collar Bioinformatics Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		        
		    
		    <li><a href="http://localhost:4000/" >About</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/articles/" >Recent</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/tags/" >Topics</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title animated fadeIn"><a href="http://localhost:4000/">Blue Collar Bioinformatics</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Biological data analysis, validation and visualization</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="http://localhost:4000/tags/#how-to" title="Pages tagged how-to">how-to</a></span>
        
          <h1 class="entry-title">MapReduce implementation of GFF parsing for Biopython</h1>
        
      </header>
      <footer class="entry-meta">
        
          
        
          <img src="http://localhost:4000/images/diego-work.jpg" class="bio-photo" alt="Brad Chapman bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Brad Chapman</span></span>
        <span class="entry-date date published"><time datetime="2009-03-22T10:59:46-04:00"><i class="fa fa-calendar-o"></i> March 22, 2009</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        
      </footer>
      <div class="entry-content">
        <p>
I previously wrote up details about <a href="http://bcb.io/2009/03/08/initial-gff-parser-for-biopython/">starting a GFF parser for Biopython</a>. In addition to incorporating suggestions received on the <a href="http://biopython.org/wiki/Mailing_lists">Biopython mailing list</a>, it has been redesigned for parallel computation using <a href="http://discoproject.org/">Disco</a>. Disco is an implementation of the distributed <a href="http://en.wikipedia.org/wiki/MapReduce">MapReduce</a> framework in Erlang and Python. The code is available from the <a href="http://github.com/chapmanb/bcbb/tree/be2f4f1714b67aa8e428b747c74c81cdd0451072/gff">git repository</a>; this post describes the impetus and design behind the MapReduce revision.</p>
<p>
The scale of biological analyses is growing quickly thanks to new sequencing technologies. Bioinformatics programmers will need to learn techniques to rapidly analyze extremely large data sets. My coding toolbox has expanded to tackle these problems in two ways. The first is exploring programming languages designed for speed and parallelism, like <a href="http://en.wikipedia.org/wiki/Haskell_(programming_language)">Haskell</a>. Additionally, I have been learning general techniques for parallelizing programs. Both require re-thinking code design to take advantage of increasingly available multi-processor and clustered architectures.</p>
<p>
The MapReduce framework, originally proposed by Google, exemplifies the idea of redesigning code to analyze large data sets in parallel. In short, the programmer writes two functions: map and reduce. The map function handles the raw parsing work; for instance, it parses a line of GFF text and structures the details of interest. The reduce function combines the results from the map parsing, making them available for additional processing outside of the parallel part of the job. Several implementations of MapReduce have become popularly used. Apache's <a href="http://hadoop.apache.org/core/">Hadoop</a> is a mature Java implementation with an underlying distributed file system. Here we utilize Disco, an implementation in Erlang and Python from <a href="http://research.nokia.com/">Nokia Research Center</a>.</p>
<p>
The MapReduce GFF parser consists of <a href="http://github.com/chapmanb/bcbb/blob/be2f4f1714b67aa8e428b747c74c81cdd0451072/gff/BCBio/GFF/GFFParser.py">two standalone functions</a>. The map function takes a line of GFF text and first determines if we should parse it based on a set of limits. This allows the user to only pull items of interest from the GFF file, saving memory and time:</p>
<p>[sourcecode language="python"]<br />
def _gff_line_map(line, params):<br />
    strand_map = {'+' : 1, '-' : -1, '?' : None, None: None}<br />
    line = line.strip()<br />
    if line[0] != "#":<br />
        parts = line.split('\t')<br />
        should_do = True<br />
        if params.limit_info:<br />
            for limit_name, limit_values in params.limit_info.items():<br />
                cur_id = tuple([parts[i] for i in<br />
                    params.filter_info[limit_name]])<br />
                if cur_id not in limit_values:<br />
                    should_do = False<br />
                    break<br />
[/sourcecode]</p>
<p>
If the GFF line is to be parsed, we use it to build a dictionary with all the details. Additionally, the line is classified as a top level annotation, a standard flat feature with a location, or part of a parent/child nested feature. The results are returned as a dictionary. For the disco parallel implementation, we use <a href="http://www.json.org/">JSON</a> to convert the dictionary into a flattened string:</p>
<p>[sourcecode language="python"]<br />
        if should_do:<br />
            assert len(parts) == 9, line<br />
            gff_parts = [(None if p == '.' else p) for p in parts]<br />
            gff_info = dict()<br />
            # collect all of the base qualifiers for this item<br />
            quals = collections.defaultdict(list)<br />
            if gff_parts[1]:<br />
                quals["source"].append(gff_parts[1])<br />
            if gff_parts[5]:<br />
                quals["score"].append(gff_parts[5])<br />
            if gff_parts[7]:<br />
                quals["phase"].append(gff_parts[7])<br />
            for key, val in [a.split('=') for a in gff_parts[8].split(';')]:<br />
                quals[key].extend(val.split(','))<br />
            gff_info['quals'] = dict(quals)<br />
            gff_info['rec_id'] = gff_parts[0]<br />
            # if we are describing a location, then we are a feature<br />
            if gff_parts[3] and gff_parts[4]:<br />
                gff_info['location'] = [int(gff_parts[3]) - 1,<br />
                        int(gff_parts[4])]<br />
                gff_info['type'] = gff_parts[2]<br />
                gff_info['id'] = quals.get('ID', [''])[0]<br />
                gff_info['strand'] = strand_map[gff_parts[6]]<br />
                # Handle flat features<br />
                if not gff_info['id']:<br />
                    final_key = 'feature'<br />
                # features that have parents need to link so we can pick up<br />
                # the relationship<br />
                elif gff_info['quals'].has_key('Parent'):<br />
                    final_key = 'child'<br />
                # top level features<br />
                else:<br />
                    final_key = 'parent'<br />
            # otherwise, associate these annotations with the full record<br />
            else:<br />
                final_key = 'annotation'<br />
            return [(final_key, (simplejson.dumps(gff_info) if params.jsonify<br />
                else gff_info))]<br />
[/sourcecode]</p>
<p>
The advantage of this distinct map function is that it can be run in parallel for any line in the file. To condense the results back into a synchronous world, the reduce function takes the results of the map function and combines them into a dictionary of results:</p>
<p>[sourcecode language="python"]<br />
def _gff_line_reduce(map_results, out, params):<br />
    final_items = dict()<br />
    for gff_type, final_val in map_results:<br />
        send_val = (simplejson.loads(final_val) if params.jsonify else<br />
                final_val)<br />
        try:<br />
            final_items[gff_type].append(send_val)<br />
        except KeyError:<br />
            final_items[gff_type] = [send_val]<br />
    for key, vals in final_items.items():<br />
        out.add(key, (simplejson.dumps(vals) if params.jsonify else vals))<br />
[/sourcecode]</p>
<p>Finally, the dictionaries of GFF information are converted into Biopython SeqFeatures and attached to SeqRecord objects; the standard object interface is identical to that used for GenBank feature files.</p>
<p>
Re-writing the code sped it up by a roughly calculated 10% for single processor work. Splitting up parsing and object creation allowed me to apply some simple speed ups which contributed to this improvement. The hidden advantage of learning new programming frameworks is that it encourages you to think about familiar problems in different ways.</p>
<p>
This implementation is designed to work both in parallel using Disco, and locally on a standard machine. Practically, this means that Disco is not required unless you care about parallelizing the code. Parallel coding may also not be the right approach for a particular problem. For small files, it is more efficient to run the code locally and avoid the overhead involved with making it parallel.</p>
<p>
When you suddenly need to apply your small GFF parsing script to many gigabytes of result data the code will scale accordingly by incorporating Disco. To look at the practical numbers related to this scaling, I plan to follow up on this post with tests <a href="http://discoproject.org/doc/start/ec2setup.html#ec2setup">using Disco on Amazon's Elastic Compute Cloud</a>.</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'bcbio'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/2009/03/15/biosql-on-google-app-engine/" class="btn" title="BioSQL on Google App Engine">Previous</a>
      
      
        <a href="http://localhost:4000/2009/03/29/python-gff-parser-update-parallel-parsing-and-gff2/" class="btn" title="Python GFF parser update -- parallel parsing and GFF2">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<div class="social-icons">
	<a href="https://twitter.com/chapmanb" title="Brad Chapman on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://github.com/chapmanb" title="Brad Chapman on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	<a href="https://github.com/chapmanb" title="Brad Chapman on Bitbucket" target="_blank"><i class="fa fa-bitbucket-square fa-2x"></i></a>
	
	
	
	
	
	
  
	
	<a href="https://linkedin.com/pub/3/300/8ba" title="Brad Chapman on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
  <a href="http://feeds2.feedburner.com/bcbio" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>




</body>
</html>
