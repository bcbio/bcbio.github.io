<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Automated protein conservation display from BLAST alignments &#8211; Blue Collar Bioinformatics</title>

<meta name="keywords" content="how-to, visualization">

  

<!-- Twitter Cards -->
<meta name="twitter:title" content="Automated protein conservation display from BLAST alignments">

<meta name="twitter:site" content="@chapmanb">
<meta name="twitter:creator" content="@chapmanb">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Automated protein conservation display from BLAST alignments">

<meta property="og:url" content="http://localhost:4000/2009/02/07/automated-protein-conservation-display-from-blast-alignments/">
<meta property="og:site_name" content="Blue Collar Bioinformatics">





<link rel="canonical" href="http://localhost:4000/2009/02/07/automated-protein-conservation-display-from-blast-alignments/">
<link href="http://feeds2.feedburner.com/bcbio" type="application/atom+xml" rel="alternate" title="Blue Collar Bioinformatics Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		        
		    
		    <li><a href="http://localhost:4000/" >About</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/articles/" >Recent</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/tags/" >Topics</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title animated fadeIn"><a href="http://localhost:4000/">Blue Collar Bioinformatics</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Biological data analysis, validation and visualization</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="http://localhost:4000/tags/#how-to" title="Pages tagged how-to">how-to</a>&nbsp;&bull;&nbsp;<a href="http://localhost:4000/tags/#visualization" title="Pages tagged visualization">visualization</a></span>
        
          <h1 class="entry-title">Automated protein conservation display from BLAST alignments</h1>
        
      </header>
      <footer class="entry-meta">
        
          
        
          <img src="http://localhost:4000/images/diego-work.jpg" class="bio-photo" alt="Brad Chapman bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Brad Chapman</span></span>
        <span class="entry-date date published"><time datetime="2009-02-07T17:18:25-05:00"><i class="fa fa-calendar-o"></i> February 07, 2009</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        
        
      </footer>
      <div class="entry-content">
        <p>
Pawel at <a href="http://freelancingscience.com">Freelancing Science</a> had an <a href="http://freelancingscience.com/2009/02/03/structure-prediction-visual-inspection-of-blast-results/">excellent post</a> about making structural predictions from visual analysis of BLAST alignments. This concept inspired me to put together an automated solution to visualize protein conservation. Starting with a protein of interest it will retrieve the relevant identifier from NCBI, do a remote BLAST, examine the alignments to related divergent proteins, calculate conservation and display a plot of the results.</p>
<p>
With a protein identifier like a GenBank accession number or <a href="http://www.uniprot.org/">UniProt</a> ID, we first need to find the standard <a href="http://www.ncbi.nlm.nih.gov/Sitemap/sequenceIDs.html">NCBI GI number</a>. Using <a href="http://biopython.org/DIST/docs/tutorial/Tutorial.html">Biopython's</a> Entrez module:</p>
<p>[sourcecode language="python"]<br />
def search_for_gi(self, uniprot_id, db_name):<br />
    handle = Entrez.esearch(db=db_name, term=uniprot_id)<br />
    record = Entrez.read(handle)<br />
    ids = record["IdList"]<br />
    if len(ids) == 0:<br />
        raise ValueError("Not found in NCBI: %s" % ids)<br />
    return ids[0]<br />
[/sourcecode]</p>
<p>
Given the GI, a remote BLAST is performed and the XML result is parsed into a record object. This is again done using Biopython libraries, with the BLAST result cached in case of re-runs. If you were using this code for many queries or on a web page presented to scientists, it would make sense to use a local BLAST for speed purposes. This could easily be plugged in, again using Biopython. Here is the remote version:</p>
<p>[sourcecode language="python"]<br />
def remote_blast(self, search_gi, blast_method):<br />
    out_file = os.path.join(self._cache_dir, "%s_%s_blo.xml" % (blast_method,<br />
        search_gi))<br />
    if not os.path.exists(out_file):<br />
        blast_handle = NCBIWWW.qblast(blast_method, "nr", search_gi)<br />
        with open(out_file, 'w') as out_handle:<br />
            for line in blast_handle:<br />
                out_handle.write(line)<br />
        blast_handle.close()<br />
    with open(out_file) as in_handle:<br />
        rec_it = NCBIXML.parse(in_handle)<br />
        return rec_it.next()<br />
[/sourcecode]</p>
<p>
With the parsed record, the next step is to loop over the alignments to calculate conservation across the protein. To provide quantitative results, a protein <a href="http://en.wikipedia.org/wiki/Substitution_matrix">substitution matrix</a> provides a score for each BLAST alignment character pair. Higher scores indicate a more conserved alignment, with exact matches being the highest scores. We use the <a href="ftp://selab.janelia.org/pub/publications/Eddy-ATG2/Eddy-ATG2-reprint.pdf">BLOSUM62</a> matrix here, although a wide variety are supported by Biopython. The class below loops through all of the alignments and high scoring pairs (HSP, in BLAST nomenclature), notes the position, and uses the alignment pairs and matrix to assign conservation scores at each position:</p>
<p>[sourcecode language="python"]<br />
class BlastConservationCalculator:<br />
    def __init__(self, matrix_name="blosum62"):<br />
        self._subs_mat = getattr(MatrixInfo, matrix_name)<br />
        self._no_use_thresh = 0.95</p>
<p>    def conservation_dict(self, blast_rec):<br />
        cons_dict = {}<br />
        rec_size = int(blast_rec.query_letters)<br />
        for base_index in range(rec_size):<br />
            cons_dict[base_index] = []<br />
        for align in blast_rec.alignments:<br />
            for hsp in align.hsps:<br />
                if (float(hsp.identities) / float(rec_size) <=<br />
                        self._no_use_thresh):<br />
                    cons_dict = self._add_hsp_conservation(hsp, cons_dict)<br />
        return cons_dict</p>
<p>    def _add_hsp_conservation(self, hsp, cons_dict):<br />
        start_index = int(hsp.query_start) - 1<br />
        hsp_index = 0<br />
        for q_index in range(len(hsp.query)):<br />
            if (hsp.query[q_index] != '-'):<br />
                if (hsp.sbjct[q_index] != '-'):<br />
                    try:<br />
                        sub_val = self._subs_mat[(hsp.query[q_index],<br />
                                                  hsp.sbjct[q_index])]<br />
                    except KeyError:<br />
                        sub_val = self._subs_mat[(hsp.sbjct[q_index],<br />
                                                  hsp.query[q_index])]<br />
                    cons_dict[start_index + hsp_index].append(sub_val)<br />
                hsp_index += 1<br />
        return cons_dict<br />
[/sourcecode]</p>
<p>
The result of this work is a dictionary of score conservation at each position. If you plot the average of these scores directly, it results in a very choppy graph which is hard to interpret. Luckily, Andrew Dalke has tackled this problem and presented a detailed writeup of <a href="http://www.dalkescientific.com/writings/NBN/plotting.html">smoothing scores for plotting</a>. Using the Savitzky-Golay technique described there, the smoothed average of the results are plotted using <a href="http://matplotlib.sourceforge.net/">matplotlib</a>:</p>
<p>[sourcecode language="python"]<br />
window_size = 29<br />
data_smoother = SavitzkyGolayDataSmoother(window_size)<br />
pos_data = []<br />
cons_data = []<br />
for pos in indexes:<br />
    pos_data.append(pos + 1)<br />
    if len(cons_dict[pos]) > 0:<br />
        cons_data.append(numpy.median(cons_dict[pos]))<br />
    else:<br />
        cons_dict.append(0)<br />
smooth_data = data_smoother.smooth_values(cons_data)<br />
smooth_pos_data = pos_data[data_smoother.half_window():<br />
        len(pos_data) - data_smoother.half_window()]<br />
pylab.plot(smooth_pos_data, smooth_data)<br />
pylab.axis(xmin=min(pos_data), xmax=max(pos_data))<br />
pylab.xlabel("Amino acid position")<br />
pylab.ylabel("Conservation")<br />
pylab.savefig('%s_conservation.png' % accession.replace(".", "_"))<br />
[/sourcecode]</p>
<p>
The resulting plot was prepared for the example from Pawel's post that inspired all this and is shown below. We can see the 4 regions of less conservation noted by Pawel by inspection of the alignment, along with the 3 intervening peaks of conservation:</p>
<p>[caption id="attachment_65" align="alignnone" width="400" caption=""]<img src="http://bcbio.files.wordpress.com/2009/02/baa36600_1_conservation.png?w=300" alt="Example conservation plot" title="baa36600_1_conservation" width="400" height="300" class="size-medium wp-image-65" />[/caption]<br /></p>
<p>
The <a href="http://github.com/chapmanb/bcbb/blob/4b071bae975da92da56d8f0df0f1a987444e57d4/visualize/blast_conservation_plot.py">full script</a> puts all of these parts together into a working version that could be used for your own proteins of interest. These plots are useful for getting a quick overview of protein conservation when working with a new protein. They could be used to compare with known regions like domains, to identify likely regions of importance for protein deletion studies, or to make structure evaluations. The intriguing aspect of the plots is the opportunity to quickly evaluate and make predictions for experimental study.</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'bcbio'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/2009/01/31/location-and-duplication-information-from-ensembl/" class="btn" title="Location and duplication information from Ensembl">Previous</a>
      
      
        <a href="http://localhost:4000/2009/02/13/organization-of-literature-using-pubmed-related-articles/" class="btn" title="Organization of literature using PubMed related articles">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<div class="social-icons">
	<a href="https://twitter.com/chapmanb" title="Brad Chapman on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://github.com/chapmanb" title="Brad Chapman on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	<a href="https://github.com/chapmanb" title="Brad Chapman on Bitbucket" target="_blank"><i class="fa fa-bitbucket-square fa-2x"></i></a>
	
	
	
	
	
	
  
	
	<a href="https://linkedin.com/pub/3/300/8ba" title="Brad Chapman on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
  <a href="http://feeds2.feedburner.com/bcbio" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>




</body>
</html>
